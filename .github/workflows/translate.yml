name: Translate Repository Content (Production)

on:
  workflow_dispatch:
    inputs:
      repository_url:
        description: "ç¿»è¨³å¯¾è±¡ã®ãƒªãƒã‚¸ãƒˆãƒª URL (ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å ´åˆã¯ãã® URL)"
        required: true
        default: "https://github.com/microsoft/agent-framework"
        type: string
      subdirectory:
        description: "å¯¾è±¡ãŒãƒ¢ãƒãƒ¬ãƒã®å ´åˆã®ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹ (../ ã‚„çµ¶å¯¾ãƒ‘ã‚¹ä¸å¯)"
        required: false
        default: "python"
        type: string
      include_log_messages:
        description: "logger / print ã‚‚æŠ½å‡ºå¯¾è±¡ã«å«ã‚ã‚‹"
        required: false
        default: false
        type: boolean
      exclude_terms:
        description: "å’Œè¨³ã®å¯¾è±¡ã‹ã‚‰é™¤å¤–ã™ã‚‹å˜èªç¾¤ï¼ˆè‡ªç„¶è¨€èªã§æŒ‡å®šï¼‰"
        required: false
        default: ""
        type: string
      batch_size:
        description: "ç¿»è¨³æ™‚ã®ãƒãƒƒãƒã‚µã‚¤ã‚º"
        required: false
        default: 5
        type: number
      translation_limit:
        description: "ç¿»è¨³ä»¶æ•°ã®ä¸Šé™ (æ–‡å­—åˆ—å…¥åŠ›ãƒ»'0' æŒ‡å®šã§ç„¡åˆ¶é™)"
        required: false
        default: 10
        type: number
      artifact_dir:
        description: "æˆæœç‰©ã‚’ä¿å­˜ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª"
        required: false
        default: "translated"
        type: string

jobs:
  prepare:
    name: Extract And Summarize
    runs-on: ubuntu-latest
    outputs:
      token-summary: ${{ steps.summary.outputs.json }}
    steps:
      - name: Checkout comment-translator repository
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v2

      - name: Install dependencies
        run: uv sync --frozen

      - name: Clone target repository
        run: |
          git clone --depth 1 "${{ inputs.repository_url }}" target-repo
          if [ -n "${{ inputs.subdirectory }}" ]; then
            case "${{ inputs.subdirectory }}" in
              /*|*../*)
                echo "Invalid subdirectory: ${{ inputs.subdirectory }}" >&2
                exit 1
                ;;
            esac
          fi

      - name: Extract docstrings and comments
        run: |
          mkdir -p out
          ARGS=""
          if [[ "${{ inputs.include_log_messages }}" == 'true' ]]; then
            ARGS="${ARGS} --include-log-messages"
          fi
          uv run python main.py extract target-repo/${{ inputs.subdirectory }} \
            --output out/extracted.jsonl \
            $ARGS \
            --log-level INFO

      - name: Summarize token usage
        id: summary
        run: |
          uv run python scripts/summarize_tokens.py \
            --input out/extracted.jsonl \
            --output out/token-summary.json
          
          # GitHub Outputã«ä¿å­˜
          SUMMARY=$(cat out/token-summary.json)
          echo "json=$SUMMARY" >> "$GITHUB_OUTPUT"
          
          # Step Summaryã«è©³ç´°è¡¨ç¤º
          ITEMS=$(jq '.items // (.items | length?)' out/token-summary.json)
          TOKENS=$(jq '.tokens' out/token-summary.json)
          AVG_TOKENS=$(jq '.average_tokens' out/token-summary.json)
          MAX_TOKENS=$(jq '.max_tokens // 0' out/token-summary.json)
          MIN_TOKENS=$(jq '.min_tokens // 0' out/token-summary.json)
          
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          ## ğŸ“Š ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚µãƒãƒª
          
          | é …ç›® | å€¤ |
          |------|------|
          | æŠ½å‡ºä»¶æ•° | **${ITEMS}ä»¶** |
          | ç·ãƒˆãƒ¼ã‚¯ãƒ³æ•° | **${TOKENS}** |
          | å¹³å‡ãƒˆãƒ¼ã‚¯ãƒ³æ•° | **${AVG_TOKENS}** |
          | æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•° | ${MAX_TOKENS} |
          | æœ€å°ãƒˆãƒ¼ã‚¯ãƒ³æ•° | ${MIN_TOKENS} |
          
          > âš ï¸ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ç¿»è¨³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚æ‰¿èªãŒå¿…è¦ã§ã™ã€‚
          EOF
          
          # ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚è¡¨ç¤º
          echo "============================================"
          echo "ğŸ“Š ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚µãƒãƒª"
          echo "============================================"
          echo "æŠ½å‡ºä»¶æ•°: ${ITEMS}ä»¶"
          echo "ç·ãƒˆãƒ¼ã‚¯ãƒ³æ•°: ${TOKENS}"
          echo "å¹³å‡ãƒˆãƒ¼ã‚¯ãƒ³æ•°: ${AVG_TOKENS}"
          echo "æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°: ${MAX_TOKENS}"
          echo "æœ€å°ãƒˆãƒ¼ã‚¯ãƒ³æ•°: ${MIN_TOKENS}"
          echo "============================================"

      - name: Upload extraction artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prepare-artifacts
          path: |
            out/extracted.jsonl
            out/token-summary.json
            run.log

  translate:
    name: Translate And Apply
    runs-on: ubuntu-latest
    needs: prepare
    environment: translation-approval
    steps:
      - name: Checkout comment-translator repository
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v2

      - name: Install dependencies
        run: uv sync --frozen

      - name: Clone target repository
        run: |
          git clone --depth 1 "${{ inputs.repository_url }}" target-repo

      - name: Download extraction artifact
        uses: actions/download-artifact@v4
        with:
          name: prepare-artifacts
          path: out

      - name: Show token summary
        run: |
          echo "============================================"
          echo "ğŸ“Š ç¿»è¨³å‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª"
          echo "============================================"
          cat out/token-summary.json | jq -r '
            "æŠ½å‡ºä»¶æ•°: \(.items // (.items | length?))ä»¶",
            "ç·ãƒˆãƒ¼ã‚¯ãƒ³æ•°: \(.tokens)",
            "å¹³å‡ãƒˆãƒ¼ã‚¯ãƒ³æ•°: \(.average_tokens)",
            "æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°: \(.max_tokens // 0)",
            "æœ€å°ãƒˆãƒ¼ã‚¯ãƒ³æ•°: \(.min_tokens // 0)"
          '
          echo "============================================"
          echo ""
          echo "âš ï¸  ã“ã®ã‚¸ãƒ§ãƒ–ã¯ environment: translation-approval ã§ä¿è­·ã•ã‚Œã¦ã„ã¾ã™"
          echo "âš ï¸  ç¿»è¨³ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ GitHub UI ã§æ‰¿èªãŒå¿…è¦ã§ã™"
          echo ""

      - name: Run translation
        run: |
          mkdir -p out
          TRANSLATE_ARGS=("--batch-size" "${{ inputs.batch_size }}")
          if [ "${{ inputs.translation_limit }}" != "0" ]; then
              TRANSLATE_ARGS+=("--limit" "${{ inputs.translation_limit }}")
          fi
          if [ -n "${{ inputs.exclude_terms }}" ]; then
              TRANSLATE_ARGS+=("--exclude-terms" "${{ inputs.exclude_terms }}")
          fi
          uv run python main.py translate out/extracted.jsonl \
            --output out/translated.jsonl \
            --failed-output out/unprocessed.jsonl \
            "${TRANSLATE_ARGS[@]}" \
            --log-level INFO

      - name: Apply translated content
        run: |
          uv run python main.py replace out/translated.jsonl \
            --output-dir out/translated_sources \
            --root target-repo/${{ inputs.subdirectory }} \
            --mode indirect \
            --log-level INFO
          if [ -d out/translated_sources ]; then
            rsync -av --ignore-existing out/translated_sources/ target-repo/${{ inputs.subdirectory }}/
          fi

      - name: Collect artifacts
        run: |
          mkdir -p ${{ inputs.artifact_dir }}
          cp out/extracted.jsonl ${{ inputs.artifact_dir }}/
          cp out/translated.jsonl ${{ inputs.artifact_dir }}/
          cp out/unprocessed.jsonl ${{ inputs.artifact_dir }}/
          cp out/token-summary.json ${{ inputs.artifact_dir }}/
          cp -R out/translated_sources ${{ inputs.artifact_dir }}/
          [ -f run.log ] && cp run.log ${{ inputs.artifact_dir }}/ || true
          echo "Artifacts saved to: ${{ inputs.artifact_dir }}"
          ls -R ${{ inputs.artifact_dir }}

      - name: Upload translation artifacts
        if: ${{ !env.ACT }}
        uses: actions/upload-artifact@v4
        with:
          name: translation-results
          path: ${{ inputs.artifact_dir }}
