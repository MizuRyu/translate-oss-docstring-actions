name: Translate Repository Content (Production)

on:
  workflow_dispatch:
    inputs:
      repository_url:
        description: "ç¿»è¨³å¯¾è±¡ã®ãƒªãƒã‚¸ãƒˆãƒª URL"
        required: true
        default: "https://github.com/microsoft/agent-framework"
        type: string
      subdirectory:
        description: "å¯¾è±¡ãŒãƒ¢ãƒãƒ¬ãƒã®å ´åˆã®ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹"
        required: false
        default: "python"
        type: string
      translation_limit:
        description: "ç¿»è¨³ä»¶æ•°ã®ä¸Šé™ (0ã§ç„¡åˆ¶é™)"
        required: false
        default: 10
        type: number
      mock_mode:
        description: "ãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œï¼ˆLLMå‘¼ã³å‡ºã—ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰"
        required: false
        default: false
        type: boolean
      no_fallback:
        description: "Fallbackç„¡åŠ¹åŒ–ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³è¶…éæ™‚ã«Azure Fallbackã—ãªã„ï¼‰"
        required: false
        default: false
        type: boolean
      include_log_messages:
        description: "logger/printã‚‚æŠ½å‡ºå¯¾è±¡ã«å«ã‚ã‚‹"
        required: false
        default: false
        type: boolean
      exclude_terms:
        description: "å’Œè¨³ã‹ã‚‰é™¤å¤–ã™ã‚‹å˜èªç¾¤ï¼ˆè‡ªç„¶è¨€èªã§æŒ‡å®šï¼‰"
        required: false
        default: ""
        type: string
      push_results:
        description: "ç¿»è¨³çµæœã‚’ãƒªãƒã‚¸ãƒˆãƒªã«pushã™ã‚‹"
        required: false
        default: true
        type: boolean

jobs:
  prepare:
    name: Extract And Summarize
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      token-summary: ${{ steps.summary.outputs.json }}
    steps:
      - name: Checkout comment-translator repository
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v2

      - name: Install dependencies
        run: uv sync --frozen

      - name: Clone target repository
        run: |
          # å¤–éƒ¨ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
          git clone --depth 1 "${{ inputs.repository_url }}" target-repo

          if [ -n "${{ inputs.subdirectory }}" ]; then
            case "${{ inputs.subdirectory }}" in
              /*|*../*)
                echo "Invalid subdirectory: ${{ inputs.subdirectory }}" >&2
                exit 1
                ;;
            esac
          fi

      - name: Extract docstrings and comments
        run: |
          mkdir -p results
          ARGS=""
          if [[ "${{ inputs.include_log_messages }}" == 'true' ]]; then
            ARGS="${ARGS} --include-log-messages"
          fi
          uv run python main.py extract target-repo/${{ inputs.subdirectory }} \
            --output results/extracted.jsonl \
            $ARGS \
            --log-level INFO

      - name: Summarize token usage
        id: summary
        run: |
          # translation_limitãŒ0ã®å ´åˆã¯--limitã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ãªã„
          LIMIT_ARG=""
          if [ "${{ inputs.translation_limit }}" -gt 0 ]; then
            LIMIT_ARG="--limit ${{ inputs.translation_limit }}"
          fi

          uv run python scripts/summarize_tokens.py \
            --input results/extracted.jsonl \
            --output results/token-summary.json \
            $LIMIT_ARG

          # GitHub Outputã«ä¿å­˜ï¼ˆJSONã‚’1è¡Œã«åœ§ç¸®ï¼‰
          SUMMARY=$(jq -c '.' results/token-summary.json)
          echo "json=$SUMMARY" >> "$GITHUB_OUTPUT"

          # Step Summaryã«è©³ç´°è¡¨ç¤º
          ITEMS=$(jq '.items // (.items | length?)' results/token-summary.json)
          TOKENS=$(jq '.tokens' results/token-summary.json)
          AVG_TOKENS=$(jq '.average_tokens' results/token-summary.json)
          MAX_TOKENS=$(jq '.max_tokens // 0' results/token-summary.json)
          MIN_TOKENS=$(jq '.min_tokens // 0' results/token-summary.json)
          TOTAL_ITEMS=$(jq '.total_items // .items' results/token-summary.json)
          LIMIT=$(jq '.translation_limit // 0' results/token-summary.json)

          # åˆ¶é™ãŒã‚ã‚‹å ´åˆã®è¡¨ç¤º
          if [ "$LIMIT" != "null" ] && [ "$LIMIT" -gt 0 ]; then
            ITEMS_DISPLAY="${ITEMS}ä»¶ (å…¨${TOTAL_ITEMS}ä»¶ä¸­)"
          else
            ITEMS_DISPLAY="${ITEMS}ä»¶"
          fi

          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          ## ğŸ“Š ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚µãƒãƒª

          | é …ç›® | å€¤ |
          |------|------|
          | æŠ½å‡ºä»¶æ•° | **${ITEMS_DISPLAY}** |
          | ç·ãƒˆãƒ¼ã‚¯ãƒ³æ•° | **${TOKENS}** |
          | å¹³å‡ãƒˆãƒ¼ã‚¯ãƒ³æ•° | **${AVG_TOKENS}** |
          | æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•° | ${MAX_TOKENS} |
          | æœ€å°ãƒˆãƒ¼ã‚¯ãƒ³æ•° | ${MIN_TOKENS} |

          > âš ï¸ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ç¿»è¨³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚æ‰¿èªãŒå¿…è¦ã§ã™ã€‚
          EOF

          # ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚è¡¨ç¤º
          echo "============================================"
          echo "ğŸ“Š ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚µãƒãƒª"
          echo "============================================"
          echo "æŠ½å‡ºä»¶æ•°: ${ITEMS_DISPLAY}"
          echo "ç·ãƒˆãƒ¼ã‚¯ãƒ³æ•°: ${TOKENS}"
          echo "å¹³å‡ãƒˆãƒ¼ã‚¯ãƒ³æ•°: ${AVG_TOKENS}"
          echo "æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°: ${MAX_TOKENS}"
          echo "æœ€å°ãƒˆãƒ¼ã‚¯ãƒ³æ•°: ${MIN_TOKENS}"
          echo "============================================"

      - name: Upload extraction artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prepare-artifacts
          path: |
            results/extracted.jsonl
            results/token-summary.json

  translate:
    name: Translate And Apply
    runs-on: ubuntu-latest
    needs: prepare
    environment: translation-approval
    permissions:
      contents: write # ç¿»è¨³çµæœã‚’pushã™ã‚‹ãŸã‚
    steps:
      - name: Checkout comment-translator repository
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v2

      - name: Install dependencies
        run: uv sync --frozen

      - name: Clone target repository
        run: |
          # å¤–éƒ¨ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
          git clone --depth 1 "${{ inputs.repository_url }}" target-repo

      - name: Download extraction artifact
        uses: actions/download-artifact@v4
        with:
          name: prepare-artifacts
          path: results

      - name: Show token summary
        run: |
          echo "============================================"
          echo "ğŸ“Š ç¿»è¨³å‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª"
          echo "============================================"
          cat results/token-summary.json | jq -r '
            "æŠ½å‡ºä»¶æ•°: \(.items // (.items | length?))ä»¶",
            "ç·ãƒˆãƒ¼ã‚¯ãƒ³æ•°: \(.tokens)",
            "å¹³å‡ãƒˆãƒ¼ã‚¯ãƒ³æ•°: \(.average_tokens)",
            "æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°: \(.max_tokens // 0)",
            "æœ€å°ãƒˆãƒ¼ã‚¯ãƒ³æ•°: \(.min_tokens // 0)"
          '
          echo "============================================"
          echo ""
          echo "âš ï¸  ã“ã®ã‚¸ãƒ§ãƒ–ã¯ environment: translation-approval ã§ä¿è­·ã•ã‚Œã¦ã„ã¾ã™"
          echo "âš ï¸  ç¿»è¨³ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ GitHub UI ã§æ‰¿èªãŒå¿…è¦ã§ã™"
          echo ""

      - name: Run translation
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_MODELS_ENDPOINT: ${{ secrets.GH_MODELS_ENDPOINT }}
          AZURE_INFERENCE_ENDPOINT: ${{ secrets.AZURE_INFERENCE_ENDPOINT }}
          AZURE_INFERENCE_CREDENTIAL: ${{ secrets.AZURE_INFERENCE_CREDENTIAL }}
          AZURE_INFERENCE_MODEL: ${{ secrets.AZURE_INFERENCE_MODEL }}
          API_VERSION: ${{ secrets.API_VERSION }}
        run: |
          TRANSLATE_ARGS=()
          if [ "${{ inputs.translation_limit }}" != "0" ]; then
              TRANSLATE_ARGS+=("--limit" "${{ inputs.translation_limit }}")
          fi
          if [ -n "${{ inputs.exclude_terms }}" ]; then
              TRANSLATE_ARGS+=("--exclude-terms" "${{ inputs.exclude_terms }}")
          fi
          if [[ "${{ inputs.mock_mode }}" == 'true' ]]; then
              TRANSLATE_ARGS+=("--mock")
          fi
          if [[ "${{ inputs.no_fallback }}" == 'true' ]]; then
              TRANSLATE_ARGS+=("--no-fallback")
          fi
          uv run python main.py translate results/extracted.jsonl \
            --output results/translated.jsonl \
            --failed-output results/unprocessed.jsonl \
            "${TRANSLATE_ARGS[@]}" \
            --log-level INFO

      - name: Apply translated content
        run: |
          # ã¾ãštarget-repoå…¨ä½“ã‚’results/artifactsã«ã‚³ãƒ”ãƒ¼ï¼ˆå…ƒã®æ§‹é€ ã‚’ä¿æŒï¼‰
          echo "============================================"
          echo "ğŸ“‚ target-repo/${{ inputs.subdirectory }} ã‚’ results/artifacts ã«ã‚³ãƒ”ãƒ¼..."

          mkdir -p results/artifacts
          rsync -av target-repo/${{ inputs.subdirectory }}/ results/artifacts/

          echo "âœ… å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ã‚’ã‚³ãƒ”ãƒ¼å®Œäº†"
          echo "============================================"

          # ç¿»è¨³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã§ä¸Šæ›¸ã
          echo "ï¿½ ç¿»è¨³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©ç”¨ä¸­..."
          uv run python main.py replace results/translated.jsonl \
            --output-dir results/artifacts \
            --root target-repo/${{ inputs.subdirectory }} \
            --log-level INFO

          echo "âœ… ç¿»è¨³é©ç”¨å®Œäº†ï¼ˆç¿»è¨³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸Šæ›¸ãã€æœªç¿»è¨³ãƒ•ã‚¡ã‚¤ãƒ«ã¯å…ƒã®ã¾ã¾ï¼‰"
          echo "============================================"

      - name: Upload translation artifacts
        if: ${{ !env.ACT }}
        uses: actions/upload-artifact@v4
        with:
          name: translation-results
          path: results

      - name: Commit and push results (GitHub only)
        if: ${{ !env.ACT && inputs.push_results }}
        run: |
          # Gitè¨­å®š
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # ãƒ‡ãƒãƒƒã‚°æƒ…å ±
          echo "============================================"
          echo "ğŸ“‚ results/ ã®å†…å®¹:"
          ls -lah results/
          echo "============================================"
          echo "ğŸ“‚ results/artifacts ã®æ§‹é€ :"
          tree -L 2 results/artifacts || find results/artifacts -type d | head -20
          echo "============================================"

          # results/ å…¨ä½“ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          echo "ğŸ“¦ results/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ä¸­..."
          git add results/

          # å¤‰æ›´å†…å®¹ã‚’è¡¨ç¤º
          echo "ğŸ“ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
          git diff --staged --name-only || echo "å¤‰æ›´ãªã—"
          echo "ğŸ“ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°ï¼ˆæœ€åˆã®10ä»¶ï¼‰:"
          git diff --staged --stat | head -11
          echo "============================================"

          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if git diff --staged --quiet; then
            echo "âš ï¸ å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—"
          else
            # ãƒ–ãƒ©ãƒ³ãƒåã‚’ç”Ÿæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãï¼‰
            TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
            BRANCH_NAME="translation/results-${TIMESTAMP}"
            
            echo "ğŸŒ¿ æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ: ${BRANCH_NAME}"
            git checkout -b "${BRANCH_NAME}"
            
            ITEMS=$(jq -r '.items // 0' results/token-summary.json)
            TOTAL=$(jq -r '.total_items // 0' results/token-summary.json)
            
            git commit -m "chore(translation): docstring/ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¿»è¨³ + ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å…¨ä½“" \
              -m "Translated: ${ITEMS} items (Total extracted: ${TOTAL})" \
              -m "Includes: translated files + unchanged files (full clone)" \
              -m "Timestamp: ${TIMESTAMP}"
            
            echo "ğŸš€ ãƒ–ãƒ©ãƒ³ãƒ ${BRANCH_NAME} ã‚’ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
            git push -u origin "${BRANCH_NAME}"
            echo "âœ… ç¿»è¨³çµæœã‚’æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒ ${BRANCH_NAME} ã«pushã—ã¾ã—ãŸ"
            echo "ğŸ“‹ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„: https://github.com/${{ github.repository }}/compare/${BRANCH_NAME}"
          fi
